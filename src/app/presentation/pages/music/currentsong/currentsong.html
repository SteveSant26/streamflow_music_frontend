<!-- Contenedor principal con gradiente continuo -->
<div
  class="main-container"
  [class.with-lyrics]="showLyricsPanel"
  [style.background]="currentSong.gradient"
  *ngIf="currentSong"
>
  <div class="reproductor-content">
    <!-- Header con botón de regreso -->
    <div class="current-song-header">
      <button (click)="goBack()" class="back-button" aria-label="Volver">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1 class="current-song-title">Reproduciendo ahora</h1>

      <!-- Botones en la esquina superior derecha -->
      <div class="header-actions">
        <!-- Botón de playlist -->
        <button
          (click)="togglePlaylistPanel()"
          class="playlist-button"
          aria-label="Ver playlist"
        >
          <mat-icon>queue_music</mat-icon>
        </button>

        <!-- Botón de letras -->
        <button
          (click)="toggleLyricsPanel()"
          class="lyrics-button"
          aria-label="Ver letras"
          [class.active]="showLyricsPanel"
        >
          <mat-icon>lyrics</mat-icon>
        </button>
      </div>
    </div>

    <!-- Imagen de la canción -->
    <div class="song-artwork-container">
      <div class="song-artwork-wrapper" [class.loading]="currentSong.isLoading">
        <img
          [src]="currentSong.cover"
          [alt]="currentSong.title"
          class="song-artwork"
          (load)="onImageLoad($event)"
          (error)="onImageError($event)"
          crossorigin="anonymous"
        />
        <!-- Indicador de buffering -->
        <div *ngIf="currentSong.isLoading" class="buffering-indicator">
          <div class="buffering-spinner"></div>
          Cargando...
        </div>
      </div>
    </div>

    <!-- Espaciador flexible -->
    <div class="flexible-spacer"></div>

    <!-- Información de la canción -->
    <div class="song-info" [class.loading]="currentSong.isLoading">
      <h2 class="song-title">{{ currentSong.title }}</h2>
      <p class="song-artist">{{ currentSong.artist }}</p>
      <p class="song-album">{{ currentSong.album }}</p>
    </div>

    <!-- Barra de progreso -->
    <div class="progress-section">
      <!-- Indicador de carga superior -->
      <div *ngIf="currentSong.isLoading" class="loading-indicator">
        <div class="loading-bar"></div>
      </div>
      
      <div class="time-display">
        <span class="current-time">{{ currentSong.currentTime }}</span>
        <span class="total-time">{{ currentSong.duration }}</span>
      </div>
      <div class="progress-bar-container" [class.loading]="currentSong.isLoading">
        <button class="w-full h-2 bg-white/30 rounded-full cursor-pointer relative border-none p-0" 
                (click)="onProgressClick($event)"
                (keydown)="onProgressKeydown($event)"
                [disabled]="currentSong.isLoading"
                aria-label="Barra de progreso">
          <!-- Progress Fill -->
          <div 
            class="h-full bg-gradient-to-r from-white to-gray-200 rounded-full transition-all duration-300 ease-out relative shadow-lg progress-bar-fill"
            [style.width.%]="currentSong.progress">
            <!-- Progress Thumb -->
            <div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-xl border-2 border-white/50 opacity-0 hover:opacity-100 transition-opacity duration-200"></div>
          </div>
        </button>
      </div>
    </div>

    <!-- Controles de reproducción -->
    <div class="player-controls" [class.loading]="currentSong.isLoading">
      <!-- Shuffle control -->
      <button
        (click)="toggleShuffle()"
        class="control-button secondary"
        [class.active]="isShuffleEnabled()"
        [disabled]="currentSong.isLoading"
        aria-label="Reproducción aleatoria"
        title="Reproducción aleatoria"
      >
        <mat-icon>shuffle</mat-icon>
      </button>

      <button
        (click)="skipPrevious()"
        class="control-button secondary"
        [disabled]="currentSong.isLoading"
        aria-label="Canción anterior"
      >
        <mat-icon>skip_previous</mat-icon>
      </button>

      <button
        (click)="togglePlayPause()"
        class="control-button primary"
        [disabled]="currentSong.isLoading"
        [attr.aria-label]="currentSong.isPlaying ? 'Pausar' : 'Reproducir'"
      >
        <!-- Mostrar spinner cuando está cargando -->
        <div *ngIf="currentSong.isLoading" class="buffering-spinner"></div>
        <mat-icon *ngIf="!currentSong.isLoading && currentSong.isPlaying">pause</mat-icon>
        <mat-icon *ngIf="!currentSong.isLoading && !currentSong.isPlaying">play_arrow</mat-icon>
      </button>

      <button
        (click)="skipNext()"
        class="control-button secondary"
        [disabled]="currentSong.isLoading"
        aria-label="Siguiente canción"
      >
        <mat-icon>skip_next</mat-icon>
      </button>

      <!-- Repeat control -->
      <button
        (click)="toggleRepeat()"
        class="control-button secondary"
        [class.active]="getRepeatMode() !== 'none'"
        [disabled]="currentSong.isLoading"
        aria-label="Repetir"
        [title]="getRepeatModeText()"
      >
        <mat-icon>{{ getRepeatMode() === 'one' ? 'repeat_one' : 'repeat' }}</mat-icon>
      </button>
    </div>

    <!-- Control de volumen -->
    <div class="volume-section" [class.loading]="currentSong.isLoading">
      <div class="volume-container">
        <button 
          (click)="toggleVolume()"
          class="p-2 rounded-full hover:bg-white/10 transition-colors duration-200 cursor-pointer"
          [disabled]="currentSong.isLoading"
          [attr.aria-label]="currentSong.volume === 0 ? 'Activar sonido' : 'Silenciar'"
        >
          <mat-icon class="volume-icon">
            {{ currentSong.volume === 0 ? 'volume_off' : (currentSong.volume < 0.5 ? 'volume_down' : 'volume_up') }}
          </mat-icon>
        </button>
        
        <div class="relative flex-1 mx-4">
          <button class="w-full h-2 bg-white/30 rounded-full cursor-pointer border-none p-0" 
                  (click)="onVolumeBarClick($event)"
                  (keydown)="onVolumeKeydown($event)"
                  [disabled]="currentSong.isLoading"
                  aria-label="Barra de volumen">
            <!-- Volume Fill -->
            <div 
              class="h-full bg-gradient-to-r from-white to-gray-200 rounded-full transition-all duration-300 ease-out relative shadow-lg"
              [style.width.%]="currentSong.volume * 100">
              <!-- Volume Thumb -->
              <div class="absolute right-0 top-1/2 transform -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-lg border border-white/50 opacity-0 hover:opacity-100 transition-opacity duration-200"></div>
            </div>
          </button>
          <!-- Hidden range input for accessibility -->
          <input
            type="range"
            min="0"
            max="100"
            [value]="currentSong.volume * 100"
            (input)="onVolumeChange($event)"
            [disabled]="currentSong.isLoading"
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
            aria-label="Control de volumen"
          />
        </div>
        
        <span class="volume-value text-white font-medium min-w-[40px] text-center">
          {{ currentSong.volume * 100 | number: "1.0-0" }}%
        </span>
      </div>
    </div>

    <!-- Footer con información adicional -->
    <div class="song-footer">
      <div class="footer-actions">
        <button class="action-button" aria-label="Agregar a favoritos">
          <mat-icon>favorite_border</mat-icon>
        </button>
        <button class="action-button" aria-label="Compartir">
          <mat-icon>share</mat-icon>
        </button>
        <button class="action-button" aria-label="Más opciones">
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Panel de letras deslizante -->
  <div class="lyrics-panel">
    <div class="lyrics-header">
      <h3>Letras</h3>
      <div class="lyrics-actions">
        <!-- Botón de actualizar letras -->
        <button
          *ngIf="hasLyrics && canLoadLyrics"
          (click)="updateLyrics()"
          class="update-lyrics-button"
          aria-label="Actualizar letras"
          title="Buscar nuevas letras"
        >
          <mat-icon>refresh</mat-icon>
        </button>

        <!-- Botón de cerrar -->
        <button
          (click)="toggleLyricsPanel()"
          class="close-lyrics-button"
          aria-label="Cerrar letras"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <div class="lyrics-content">
      <!-- Estado de carga -->
      <div *ngIf="currentSong?.lyricsLoading" class="lyrics-loading">
        <div class="loading-spinner"></div>
        <p>Buscando letras...</p>
      </div>

      <!-- Error al cargar letras -->
      <div *ngIf="currentSong?.lyricsError && !currentSong?.lyricsLoading" class="lyrics-error">
        <mat-icon>error_outline</mat-icon>
        <p>{{ currentSong.lyricsError }}</p>
        <button 
          (click)="refreshLyrics()" 
          class="retry-button"
          [disabled]="!canLoadLyrics"
        >
          Reintentar
        </button>
      </div>

      <!-- Letras disponibles -->
      <div *ngIf="hasLyrics && !currentSong?.lyricsLoading" class="lyrics-text">
        <div class="lyrics-content-scroll">
          <p 
            *ngFor="let line of currentSong.lyrics?.split('\n'); trackBy: trackByIndex" 
            class="lyrics-line"
            [class.empty-line]="line.trim() === ''"
          >
            {{ line || '&nbsp;' }}
          </p>
        </div>
      </div>

      <!-- Sin letras disponibles -->
      <div *ngIf="!hasLyrics && !currentSong?.lyricsLoading && !currentSong?.lyricsError" class="no-lyrics">
        <mat-icon>music_note</mat-icon>
        <p>No hay letras disponibles para esta canción</p>
        <div class="lyrics-buttons">
          <button 
            (click)="loadLyrics()" 
            class="search-lyrics-button"
            [disabled]="!canLoadLyrics"
          >
            Buscar letras
          </button>
          <button 
            (click)="generateLyrics()" 
            class="generate-lyrics-button"
            [disabled]="!canLoadLyrics"
            title="Generar letras usando IA"
          >
            <mat-icon>auto_awesome</mat-icon>
            Generar letras
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Componente global de playlist modal -->
<app-global-playlist-modal></app-global-playlist-modal>

<!-- Vista de carga si no hay canción -->
<div *ngIf="!currentSong" class="loading-container">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <h2>Cargando reproductor...</h2>
    <p>Preparando tu música</p>
    <div class="loading-indicator">
      <div class="loading-bar"></div>
    </div>
  </div>
</div>
